<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Using Zone Awareness in Envoy | Srinivas Anant</title><meta name=keywords content="envoy">
<meta name=description content="Using Zone Awareness in Envoy - Srinivas Anant">
<meta name=author content="Srinivas Anant">
<link rel=canonical href=https://srinivasanant.com/posts/envoy-az-awareness/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://srinivasanant.com/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://srinivasanant.com/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://srinivasanant.com/favicon-32x32.png>
<link rel=apple-touch-icon href=https://srinivasanant.com/apple-touch-icon.png>
<link rel=mask-icon href=https://srinivasanant.com/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Using Zone Awareness in Envoy">
<meta property="og:description" content>
<meta property="og:type" content="article">
<meta property="og:url" content="https://srinivasanant.com/posts/envoy-az-awareness/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2023-05-13T20:10:33+05:30">
<meta property="article:modified_time" content="2023-05-13T20:10:33+05:30">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Using Zone Awareness in Envoy">
<meta name=twitter:description content>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://srinivasanant.com/posts/"},{"@type":"ListItem","position":3,"name":"Using Zone Awareness in Envoy","item":"https://srinivasanant.com/posts/envoy-az-awareness/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using Zone Awareness in Envoy","name":"Using Zone Awareness in Envoy","description":"","keywords":["envoy"],"articleBody":"Introduction In this post we will go over how we can enable Envoy’s zone aware routing so that microservices within the same AZ can communicate with one another to reduce latency and having a second AZ as a failover.\nArchitecture overview  We are communicating from Service-A to Service-B spread across two AZs.  Prerequisites These are the prerequisites to enable zone aware routing:\n local_cluster_name must be set to the source cluster. Both definitions of the source and the destination clusters must have EDS type.  In this example, we will not be using the EDS type, we will stick to STRICT and STATIC_DNS type   Envoy must be launched with --service-zone option which defines the zone for the current host.  Cluster Name As mentioned previously we will need to define the local_cluster_name in the envoy config:\ncluster_manager:  local_cluster_name: service-a The above local_cluster_name is defined in Service-A. Similarly the local_cluster_name will change for Service-B.\nLocality Config This is the main component that should to be enabled in the cluster section along with region, zone and priority.\nlocality:  region: us-east-1  zone: us-east-1b priority: 1 Based on the priority envoy will route requests to desired microservice spread across AZs. In this example we have set two priorities - 1 for the same AZ \u0026 2 for different AZ.\nCluster block - name: service-b  connect_timeout: 10s  type: STRICT_DNS  lb_policy: ROUND_ROBIN  load_assignment:  cluster_name: service-b  endpoints:  - lb_endpoints:  - endpoint:  address:  socket_address:  address: service-b-az1  port_value: 80  locality:  region: us-east-1  zone: us-east-1a  priority: 1  - lb_endpoints:  - endpoint:  address:  socket_address:  address: service-b-az2  port_value: 80  locality:  region: us-east-1  zone: us-east-1b  priority: 2 As you can see here, Service-B has two endpoints, one in AZ-1 and the other in AZ-2 when Service-A communicates with Service-B all requests will go to microservice present in AZ-1 because the priority for it is set to 1.\nIf the priority is set to 1 for Service-B in AZ-2 then envoy will send requests to both the endpoints in a round robin fashion.\nPutting it all together Now let’s put all the individual blocks together:\ncluster_manager:  local_cluster_name: service-a  admin:  access_log_path: /tmp/admin_access.log  address:  socket_address: { address: 0.0.0.0, port_value: 5555 }  static_resources:  listeners:  - name: service-a  address:  socket_address: { address: 0.0.0.0, port_value: 80 }  filter_chains:  - filters:  - name: envoy.filters.network.http_connection_manager  typed_config:  \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager  stat_prefix: ingress_http  access_log:  - name: envoy.file_access_log  typed_config:  \"@type\": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog  path: \"/var/log/service-a.log\"  codec_type: AUTO  route_config:  name: wildcard  virtual_hosts:  - name: wildcard  domains: [\"*\"]  routes:  - match: { prefix: \"/\" }  route: { cluster: service-a, timeout: 90s }  http_filters:  - name: envoy.filters.http.router  typed_config:  \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router   - name: service-b  address:  socket_address: { address: 0.0.0.0, port_value: 8082 }  filter_chains:  - filters:  - name: envoy.filters.network.http_connection_manager  typed_config:  \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager  stat_prefix: ingress_http  access_log:  - name: envoy.file_access_log  typed_config:  \"@type\": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog  path: \"/var/log/service-b.log\"  codec_type: AUTO  route_config:  name: wildcard  virtual_hosts:  - name: wildcard  domains: [\"*\"]  routes:  - match: { prefix: \"/\" }  route: { cluster: service-b, timeout: 90s }  http_filters:  - name: envoy.filters.http.router  typed_config:  \"@type\": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router  clusters:  - name: service-a  connect_timeout: 10s  type: STATIC  lb_policy: ROUND_ROBIN  load_assignment:  cluster_name: service-a  endpoints:  - lb_endpoints:  - endpoint:  address:  socket_address:  address: 0.0.0.0  port_value: 8081  locality:  region: us-east-1  zone: us-east-1a  - name: service-b  connect_timeout: 10s  type: STRICT_DNS  lb_policy: ROUND_ROBIN  load_assignment:  cluster_name: service-b  endpoints:  - lb_endpoints:  - endpoint:  address:  socket_address:  address: service-b-az1  port_value: 80  locality:  region: us-east-1  zone: us-east-1a  priority: 1   - lb_endpoints:  - endpoint:  address:  socket_address:  address: service-b-az2  port_value: 80  locality:  region: us-east-1  zone: us-east-1b  priority: 2 Demo  First we send a curl call to Service-B via Service-A, due to the zone awareness config envoy sends requests to Service-B present in AZ-1. After I stop the Service-B container in AZ-1, the requests automatically failover to Service-B in AZ-2.  Full example Here is the link to the setup which was shown in the demo.\nConclusion By using zone awareness routing, you can reduce latency between microservices and also keep all the data transfer within the same AZ.\n","wordCount":"635","inLanguage":"en","datePublished":"2023-05-13T20:10:33+05:30","dateModified":"2023-05-13T20:10:33+05:30","author":{"@type":"Person","name":"Srinivas Anant"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://srinivasanant.com/posts/envoy-az-awareness/"},"publisher":{"@type":"Organization","name":"Srinivas Anant","logo":{"@type":"ImageObject","url":"https://srinivasanant.com/favicon.ico"}}}</script>
</head><body id=top>
<script>window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://srinivasanant.com accesskey=h title="Srinivas Anant (Alt + H)">Srinivas Anant</a>
<span class=logo-switches>
</span>
</div><ul id=menu>
<li>
<a href=https://srinivasanant.com/tags/ title=Tags>
<span>Tags</span>
</a>
</li><li>
<a href=https://srinivasanant.com/projects/ title=Projects>
<span>Projects</span>
</a>
</li><li>
<a href=https://srinivasanant.com/about/ title=About>
<span>About</span>
</a>
</li><li>
<a href=https://srinivasanant.com/archives/ title=Archives>
<span>Archives</span>
</a>
</li></ul></nav></header><main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Using Zone Awareness in Envoy
</h1><div class=post-meta><span title="2023-05-13 20:10:33 +0530 +0530">May 13, 2023</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Srinivas Anant
</div></header><div class=post-content><h3 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h3><p>In this post we will go over how we can enable Envoy&rsquo;s <a href=https://www.envoyproxy.io/docs/envoy/latest/faq/configuration/zone_aware_routing>zone aware routing</a> so that microservices within the same AZ can communicate with one another to reduce latency and having a second AZ as a failover.</p><h3 id=architecture-overview>Architecture overview<a hidden class=anchor aria-hidden=true href=#architecture-overview>#</a></h3><p><img loading=lazy src=/envoy_az.png#center alt="envoy az">
</p><ul>
<li>We are communicating from <code>Service-A</code> to <code>Service-B</code> spread across two AZs.</li></ul><h3 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h3><p>These are the <a href=https://www.envoyproxy.io/docs/envoy/latest/faq/configuration/zone_aware_routing#envoy-configuration-on-the-source-service>prerequisites</a> to enable zone aware routing:</p><ul>
<li><code>local_cluster_name</code> must be set to the source cluster.</li><li>Both definitions of the source and the destination clusters must have <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-enum-config-cluster-v3-cluster-discoverytype>EDS</a> type.
<ul>
<li>In this example, we will not be using the <code>EDS</code> type, we will stick to <code>STRICT</code> and <code>STATIC_DNS</code> type</li></ul></li><li>Envoy must be launched with <code>--service-zone</code> option which defines the zone for the current host.</li></ul><h4 id=cluster-name>Cluster Name<a hidden class=anchor aria-hidden=true href=#cluster-name>#</a></h4><p>As mentioned previously we will need to define the <code>local_cluster_name</code> in the envoy config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>cluster_manager</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>local_cluster_name</span>: <span style=color:#ae81ff>service-a</span></span></span></code></pre></div><p>The above <code>local_cluster_name</code> is defined in <code>Service-A</code>. Similarly the <code>local_cluster_name</code> will change for <code>Service-B</code>.</p><h4 id=locality-config>Locality Config<a hidden class=anchor aria-hidden=true href=#locality-config>#</a></h4><p>This is the main component that should to be enabled in the cluster section along with region, zone and priority.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>locality</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>region</span>: <span style=color:#ae81ff>us-east-1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>zone</span>: <span style=color:#ae81ff>us-east-1b</span>
</span></span><span style=display:flex><span><span style=color:#f92672>priority</span>: <span style=color:#ae81ff>1</span></span></span></code></pre></div><p>Based on the priority envoy will route requests to desired microservice spread across AZs. In this example we have set two priorities - <code>1</code> for the same AZ & <code>2</code> for different AZ.</p><h4 id=cluster-block>Cluster block<a hidden class=anchor aria-hidden=true href=#cluster-block>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>service-b</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>connect_timeout</span>: <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>STRICT_DNS</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>lb_policy</span>: <span style=color:#ae81ff>ROUND_ROBIN</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>load_assignment</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>cluster_name</span>: <span style=color:#ae81ff>service-b</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>endpoints</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>lb_endpoints</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>endpoint</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>address</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>socket_address</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>address</span>: <span style=color:#ae81ff>service-b-az1</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>port_value</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>locality</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>region</span>: <span style=color:#ae81ff>us-east-1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>zone</span>: <span style=color:#ae81ff>us-east-1a</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>priority</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>lb_endpoints</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>endpoint</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>address</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>socket_address</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>address</span>: <span style=color:#ae81ff>service-b-az2</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>port_value</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>locality</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>region</span>: <span style=color:#ae81ff>us-east-1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>zone</span>: <span style=color:#ae81ff>us-east-1b</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>priority</span>: <span style=color:#ae81ff>2</span></span></span></code></pre></div><p>As you can see here, <code>Service-B</code> has two endpoints, one in AZ-1 and the other in AZ-2 when <code>Service-A</code> communicates with <code>Service-B</code> all requests will go to microservice present in AZ-1 because the priority for it is set to <code>1</code>.</p><p>If the priority is set to <code>1</code> for <code>Service-B</code> in AZ-2 then envoy will send requests to both the endpoints in a round robin fashion.</p><h4 id=putting-it-all-together>Putting it all together<a hidden class=anchor aria-hidden=true href=#putting-it-all-together>#</a></h4><p>Now let&rsquo;s put all the individual blocks together:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>cluster_manager</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>local_cluster_name</span>: <span style=color:#ae81ff>service-a</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>admin</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>access_log_path</span>: <span style=color:#ae81ff>/tmp/admin_access.log</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>address</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>socket_address</span>: { <span style=color:#f92672>address: 0.0.0.0, port_value</span>: <span style=color:#ae81ff>5555</span> }
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#f92672>static_resources</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>listeners</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>service-a</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>address</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>socket_address</span>: { <span style=color:#f92672>address: 0.0.0.0, port_value</span>: <span style=color:#ae81ff>80</span> }
</span></span><span style=display:flex><span>    <span style=color:#f92672>filter_chains</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>filters</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.filters.network.http_connection_manager</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>typed_config</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#ae81ff>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>stat_prefix</span>: <span style=color:#ae81ff>ingress_http</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>access_log</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.file_access_log</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>typed_config</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#ae81ff>type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;/var/log/service-a.log&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>codec_type</span>: <span style=color:#ae81ff>AUTO</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>route_config</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>wildcard</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>virtual_hosts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>wildcard</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>domains</span>: [<span style=color:#e6db74>&#34;*&#34;</span>]
</span></span><span style=display:flex><span>              <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>              - <span style=color:#f92672>match</span>: { <span style=color:#f92672>prefix</span>: <span style=color:#e6db74>&#34;/&#34;</span> }
</span></span><span style=display:flex><span>                <span style=color:#f92672>route</span>: { <span style=color:#f92672>cluster: service-a, timeout</span>: <span style=color:#ae81ff>90s }</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>http_filters</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.filters.http.router</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>typed_config</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#ae81ff>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router </span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>service-b</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>address</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>socket_address</span>: { <span style=color:#f92672>address: 0.0.0.0, port_value</span>: <span style=color:#ae81ff>8082</span> }
</span></span><span style=display:flex><span>    <span style=color:#f92672>filter_chains</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>filters</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.filters.network.http_connection_manager</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>typed_config</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#ae81ff>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>stat_prefix</span>: <span style=color:#ae81ff>ingress_http</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>access_log</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.file_access_log</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>typed_config</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#ae81ff>type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;/var/log/service-b.log&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>codec_type</span>: <span style=color:#ae81ff>AUTO</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>route_config</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>wildcard</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>virtual_hosts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>wildcard</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>domains</span>: [<span style=color:#e6db74>&#34;*&#34;</span>]
</span></span><span style=display:flex><span>              <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>              - <span style=color:#f92672>match</span>: { <span style=color:#f92672>prefix</span>: <span style=color:#e6db74>&#34;/&#34;</span> }
</span></span><span style=display:flex><span>                <span style=color:#f92672>route</span>: { <span style=color:#f92672>cluster: service-b, timeout</span>: <span style=color:#ae81ff>90s }</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>http_filters</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.filters.http.router</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>typed_config</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#ae81ff>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>clusters</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>service-a</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>connect_timeout</span>: <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>STATIC</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>lb_policy</span>: <span style=color:#ae81ff>ROUND_ROBIN</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>load_assignment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>cluster_name</span>: <span style=color:#ae81ff>service-a</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>endpoints</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>lb_endpoints</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>endpoint</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>address</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>socket_address</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>address</span>: <span style=color:#ae81ff>0.0.0.0</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>port_value</span>: <span style=color:#ae81ff>8081</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>locality</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>region</span>: <span style=color:#ae81ff>us-east-1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>zone</span>: <span style=color:#ae81ff>us-east-1a</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>service-b</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>connect_timeout</span>: <span style=color:#ae81ff>10s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>STRICT_DNS</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>lb_policy</span>: <span style=color:#ae81ff>ROUND_ROBIN</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>load_assignment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>cluster_name</span>: <span style=color:#ae81ff>service-b</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>endpoints</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>lb_endpoints</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>endpoint</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>address</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>socket_address</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>address</span>: <span style=color:#ae81ff>service-b-az1</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>port_value</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>locality</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>region</span>: <span style=color:#ae81ff>us-east-1</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>zone</span>: <span style=color:#ae81ff>us-east-1a</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>priority</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>lb_endpoints</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>endpoint</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>address</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>socket_address</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>address</span>: <span style=color:#ae81ff>service-b-az2</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>port_value</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>locality</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>region</span>: <span style=color:#ae81ff>us-east-1</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>zone</span>: <span style=color:#ae81ff>us-east-1b</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>priority</span>: <span style=color:#ae81ff>2</span></span></span></code></pre></div><h3 id=demo>Demo<a hidden class=anchor aria-hidden=true href=#demo>#</a></h3><p><img loading=lazy src=/zone-awareness.gif#center alt="zone awareness">
</p><ul>
<li>First we send a curl call to <code>Service-B</code> via <code>Service-A</code>, due to the zone awareness config envoy sends requests to <code>Service-B</code> present in AZ-1.</li><li>After I stop the <code>Service-B</code> container in AZ-1, the requests automatically failover to <code>Service-B</code> in AZ-2.</li></ul><h3 id=full-example>Full example<a hidden class=anchor aria-hidden=true href=#full-example>#</a></h3><p>Here is the link to the <a href=https://github.com/jsanant/blog-post-examples/tree/main/envoy-zone-awareness>setup</a> which was shown in the demo.</p><h3 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h3><p>By using zone awareness routing, you can reduce latency between microservices and also keep all the data transfer within the same AZ.</p></div><footer class=post-footer>
<ul class=post-tags>
<li><a href=https://srinivasanant.com/tags/envoy/>envoy</a></li></ul></footer></article></main><footer class=footer>
<span>&copy; 2023 <a href=https://srinivasanant.com>Srinivas Anant</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script>
</body></html>