<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>AWS Config Rules | Srinivas Anant</title><meta name=keywords content="AWS,AWS Config">
<meta name=description content="How different trigger types work in AWS Config">
<meta name=author content="Srinivas Anant">
<link rel=canonical href=https://srinivasanant.com/posts/aws-config-rules/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://srinivasanant.com/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://srinivasanant.com/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://srinivasanant.com/favicon-32x32.png>
<link rel=apple-touch-icon href=https://srinivasanant.com/apple-touch-icon.png>
<link rel=mask-icon href=https://srinivasanant.com/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="AWS Config Rules">
<meta property="og:description" content="How different trigger types work in AWS Config">
<meta property="og:type" content="article">
<meta property="og:url" content="https://srinivasanant.com/posts/aws-config-rules/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-02-28T20:32:58+05:30">
<meta property="article:modified_time" content="2022-02-28T20:32:58+05:30">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="AWS Config Rules">
<meta name=twitter:description content="How different trigger types work in AWS Config">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://srinivasanant.com/posts/"},{"@type":"ListItem","position":3,"name":"AWS Config Rules","item":"https://srinivasanant.com/posts/aws-config-rules/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"AWS Config Rules","name":"AWS Config Rules","description":"How different trigger types work in AWS Config","keywords":["AWS","AWS Config"],"articleBody":"Introduction  Security is a part of the business, not against it.\n Auditing an environment is a daunting task no one ever wants to take up but in the era of Cloud Computing, everything is simple. In the article I will be explaining on how you can use AWS Config to audit your environment by creating custom rules and the important things to remember when creating them.\nLet’s start auditing!\n Types of Config Rules A config rule represents your desired configuration settings for specific AWS resources. If a resource violates a rule, config flags the resource and the rule as non compliant.\nThere are two types of rules:\n AWS Managed rules: AWS Config provides predefined rules which are customisable. AWS Custom rules: With AWS Config you can also create custom rules where in you have control over the logic of the rule and what violation to looks for. While AWS Config continuously tracks your resource configuration changes, it checks whether these changes violate any of the conditions in your rules.   Custom Rules When it comes to the managed rules they are a black box, you don’t have access to the lambda functions nor can you edit them since they are managed by AWS.\nThat’s where custom rules come to the rescue, when you want to check for a particular violation and a managed rule doesn’t get the job done then you will have to create a custom rule, custom basically means that the rule points to a lambda function and when the rule is evaluated config sends data to the lambda function for computation.\nThere are two ways to trigger a config rule:\n  Configuration Changes (CC): Configuration change is where the configuration of a resource changes for example, the tag on a particular instance is removed or aded. There are three scope of changes which tells Config what to look for: Resources such IAM, S3 etc. Tag for resources with particular tags. All Changes for all the resources that are recorded by Config when they are created, updated or deleted.\n  Periodic: Which triggers the Config rule at a desired frequency.\n  Important thing to remember is when to choose Configuration Changes and when to go with Periodic trigger.\nLet’s take a look at the event pattern published to lambda event during a configuration change and a periodic trigger.\nEvent pattern published to lambda during a configuration change for a EC2 instance:\n{  \"invokingEvent\": \"{\"configurationItem\": {\"configurationItemCaptureTime\":\"2016-02 17T01:36:34.043Z\",\"awsAccountId\":\"123456789012\",\"configurationItemStatus\":\"OK\",\"resourceId\":\"i-00000000\",\"ARN\":\"arn:aws:ec2:us-east-1:123456789012:instance/i-00000000\",\"awsRegion\":\"us-east-1\",\"availabilityZone\":\"us-east-1a\",\"resourceType\":\"AWS::EC2::Instance\",\"tags\":{\"Foo\":\"Bar\"},\"relationships\":[{\"resourceId\":\"eipalloc-00000000\",\"resourceType\":\"AWS::EC2::EIP\",\"name\":\"Is attached to ElasticIp\"}],\"configuration\": {\"foo\":\"bar\"}},\"messageType\":\"ConfigurationItemChangeNotification\"}, \"ruleParameters\": \"{\"Key\":\"Value\"}\", \"resultToken\": \"ResultToken\", \"eventLeftScope\": false, \"executionRoleArn\": \"arn:aws:iam::123456789012:role/config-role\", \"configRuleArn\": \"arn:aws:config:us-east-1:123456789012:config-rule/config-rule\", \"configRuleName\": \"change-triggered-config-rule\", \"configRuleId\": \"config-rule\", \"accountId\": \"123456789012\", \"version\": \"1.0\" }\nWhen it comes to periodic trigger the event pattern that is published is:\n{  \"invokingEvent\": \"{\"awsAccountId\":\"123456789012\",\"notificationCreationTime\":\"2016-07-13T21:50:00.373Z\",\"messageType\":\"ScheduledNotification\",\"recordVersion\":\"1.0\"}\",  \"ruleParameters\": \"{\"Key\":\"Value\"}\",  \"resultToken\": \"ResultToken\",  \"eventLeftScope\": false,  \"executionRoleArn\": \"arn:aws:iam::123456789012:role/config-role\",  \"configRuleArn\": \"arn:aws:config:us-east-1:123456789012:config-rule/config-rule\",  \"configRuleName\": \"periodic-config-rule\",  \"configRuleId\": \"config-rule\",  \"accountId\": \"123456789012\",  \"version\": \"1.0\" } If you take a close look at the invokingEvent in the JSON object for both the event patterns you will see that the event pattern for the configuration change has the attribute configurationItem but in the event pattern for the periodic trigger the attribute configurationItem does not exist.\nThe attribute configurationItem mainly contains details of a particular resource it’s monitoring in our case an EC2 instance, referring back to the event pattern for a configuration change you can see details such as instance id, relationship of the instance to EIPs, tags attached to the instance but the invokingEvent in the event pattern for the periodic trigger does not have any of these values and it only has accountId, messageType which are of no use to us. For more details on rest of the attributes in the Event Pattern.\nSo when it comes to using configuration change most of the work is cut out for us as config sends data about the resource we are monitoring from which we can parse the data and determine whether the rule is compliant or non compliant, if we were to use the periodic trigger we would have to make a API call to the AWS service we are checking the compliance for and send the evaluated data back to config.\nThe main drawback of using a periodic trigger is that if and when there is a change in a particular resource, config will not get triggered immediately and we wouldn’t know if there was a violation happening but we would know about it based on the frequency at which the evaluations happen which can be 1 hour, 6 hour or even the next day which is not feasible.\nWhen it comes to configurational changes the evaluations are immediate, for example, if a user attaches a EIP to a instance making it a public instance which is meant to be private then config triggers the rule and the instance is shown as non compliant due to the violation.\nBefore you create a rule you can get the configuration history of a resource by using the CLI command:\naws configservice get-resource-config-history --resource-type AWS::EC2::Instance --resource-id i-00000 --region us-east-1 With the generated configuration details you can develop your code locally.\nLet’s take a look at a custom rule which checks if the instance is publicly accessible or not and treat a publicly accessible instance as non compliant and the trigger type of this rule is configuration changes.\n lambda_handler:     In Line 5: We are parsing out the invokingEvent to get the configurationItem.\n  In Line 12: Here we are checking if the resource (instance) is deleted or not, this is an important check because if the resource is deleted we wouldn’t want stale data showing up on the config dashboard so we perform this check before we compute the evaluation.\n  evaluate_compliance:\n    In Line 13: We are checking if the instance is publicly accessible or not.  After computation it returns the compliance_type and annotation to the put_evaluations() request.\nAs you can see from the two snippets above we didn’t use any boto3 calls (Other than the put_evaluations() call to config) to the EC2 service to get details of the instance, all the data about the instance was published to lambda by config when we chose the trigger type as configuration changes.\nAs a exercise go ahead and create a custom rule and choose the trigger type as periodic trigger and see how different it is from configuration changes.\n Word to the wise:   There are some resource specific attributes that are not monitored by Config More details here. If you have a custom rule that checks if the bucket is encrypted or not you will have to use boto3 calls to fetch the details about the bucket since the AWS S3 bucket encryption is not monitored by config.\n  When you are logged into the AWS Config console and you want to evaluate a rule you would essentially click on Re-Evaluate, the most important thing note here is that it causes a configuration change to occur.\n  AWS Community repo for Custom Config Rules.\n   Since you stayed till the end you get bonus content! AWS Config is a costly service.\nAlternatives to AWS Config:  Cloud Custodian: It’s a open source tool by Capital One. Janitor Monkey: A open source tool created by Netflix but it is very restrictive to the Netflix environment. Security Monkey: Another open source tool by Netflix for monitoring your environment.   I hope this article helped you understand how to create custom Config rules and how the different trigger types work.\nThank you for reading! Hope you enjoyed it. Appreciate your feedback.\n","wordCount":"1233","inLanguage":"en","datePublished":"2022-02-28T20:32:58+05:30","dateModified":"2022-02-28T20:32:58+05:30","author":{"@type":"Person","name":"Srinivas Anant"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://srinivasanant.com/posts/aws-config-rules/"},"publisher":{"@type":"Organization","name":"Srinivas Anant","logo":{"@type":"ImageObject","url":"https://srinivasanant.com/favicon.ico"}}}</script>
</head><body id=top>
<script>window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://srinivasanant.com accesskey=h title="Srinivas Anant (Alt + H)">Srinivas Anant</a>
<span class=logo-switches>
</span>
</div><ul id=menu>
<li>
<a href=https://srinivasanant.com/tags/ title=Tags>
<span>Tags</span>
</a>
</li><li>
<a href=https://srinivasanant.com/projects/ title=Projects>
<span>Projects</span>
</a>
</li><li>
<a href=https://srinivasanant.com/about/ title=About>
<span>About</span>
</a>
</li><li>
<a href=https://srinivasanant.com/archives/ title=Archives>
<span>Archives</span>
</a>
</li></ul></nav></header><main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
AWS Config Rules
</h1><div class=post-meta><span title="2022-02-28 20:32:58 +0530 +0530">February 28, 2022</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Srinivas Anant
</div></header><div class=post-content><p><img loading=lazy src=/config_meme.jpeg#center alt="config meme">
</p><h3 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h3><blockquote>
<p>Security is a part of the business, not against it.</p></blockquote><p>Auditing an environment is a daunting task no one ever wants to take up but in the era of Cloud Computing, everything is simple. In the article I will be
explaining on how you can use AWS Config to audit your environment by creating custom rules and the important things to remember when creating them.</p><p>Let’s start auditing!</p><hr>
<h3 id=types-of-config-rules>Types of Config Rules<a hidden class=anchor aria-hidden=true href=#types-of-config-rules>#</a></h3><p>A config rule represents your desired configuration settings for specific AWS resources. If a resource violates a rule, config flags the resource and the rule as non compliant.</p><p>There are two types of rules:</p><ul>
<li>AWS Managed rules: AWS Config provides predefined rules which are customisable.</li><li>AWS Custom rules: With AWS Config you can also create custom rules where in you have control over the logic of the rule and what violation to looks for. While AWS Config continuously tracks your resource configuration changes, it checks whether these changes violate any of the conditions in your rules.</li></ul><hr>
<h3 id=custom-rules>Custom Rules<a hidden class=anchor aria-hidden=true href=#custom-rules>#</a></h3><p>When it comes to the managed rules they are a black box, you don’t have access to the lambda functions nor can you edit them since they are managed by AWS.</p><p>That’s where custom rules come to the rescue, when you want to check for a particular violation and a managed rule doesn’t get the job done then you will have to create a custom rule, custom basically means that the rule points to a lambda function and when the rule is evaluated config sends data to the lambda function for computation.</p><p>There are two ways to trigger a config rule:</p><ul>
<li>
<p>Configuration Changes (CC): Configuration change is where the configuration of a resource changes for example, the tag on a particular instance is removed or aded. There are three scope of changes which tells Config what to look for: Resources such IAM, S3 etc. Tag for resources with particular tags. All Changes for all the resources that are recorded by Config when they are created, updated or deleted.</p></li><li>
<p>Periodic: Which triggers the Config rule at a desired frequency.</p></li></ul><p>Important thing to remember is when to choose Configuration Changes and when to go with Periodic trigger.</p><p>Let’s take a look at the event pattern published to lambda event during a configuration change and a periodic trigger.</p><p>Event pattern published to lambda during a configuration change for a EC2 instance:</p><p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span> <span style=color:#e6db74>&#34;invokingEvent&#34;</span>: <span style=color:#e6db74>&#34;{&#34;</span>configurationItem<span style=color:#e6db74>&#34;: {&#34;</span>configurationItemCaptureTime<span style=color:#e6db74>&#34;:&#34;</span>2016-02 17T01:36:34.043Z<span style=color:#e6db74>&#34;,&#34;</span>awsAccountId<span style=color:#e6db74>&#34;:&#34;</span>123456789012<span style=color:#e6db74>&#34;,&#34;</span>configurationItemStatus<span style=color:#e6db74>&#34;:&#34;</span>OK<span style=color:#e6db74>&#34;,&#34;</span>resourceId<span style=color:#e6db74>&#34;:&#34;</span>i-00000000<span style=color:#e6db74>&#34;,&#34;</span>ARN<span style=color:#e6db74>&#34;:&#34;</span>arn:aws:ec2:us-east-1:123456789012:instance/i-00000000<span style=color:#e6db74>&#34;,&#34;</span>awsRegion<span style=color:#e6db74>&#34;:&#34;</span>us-east-1<span style=color:#e6db74>&#34;,&#34;</span>availabilityZone<span style=color:#e6db74>&#34;:&#34;</span>us-east-1a<span style=color:#e6db74>&#34;,&#34;</span>resourceType<span style=color:#e6db74>&#34;:&#34;</span>AWS::EC2::Instance<span style=color:#e6db74>&#34;,&#34;</span>tags<span style=color:#e6db74>&#34;:{&#34;</span>Foo<span style=color:#e6db74>&#34;:&#34;</span>Bar<span style=color:#e6db74>&#34;},&#34;</span>relationships<span style=color:#e6db74>&#34;:[{&#34;</span>resourceId<span style=color:#e6db74>&#34;:&#34;</span>eipalloc-00000000<span style=color:#e6db74>&#34;,&#34;</span>resourceType<span style=color:#e6db74>&#34;:&#34;</span>AWS::EC2::EIP<span style=color:#e6db74>&#34;,&#34;</span>name<span style=color:#e6db74>&#34;:&#34;</span>Is attached to ElasticIp<span style=color:#e6db74>&#34;}],&#34;</span>configuration<span style=color:#e6db74>&#34;: {&#34;</span>foo<span style=color:#e6db74>&#34;:&#34;</span>bar<span style=color:#e6db74>&#34;}},&#34;</span>messageType<span style=color:#e6db74>&#34;:&#34;</span>ConfigurationItemChangeNotification<span style=color:#e6db74>&#34;},
</span></span></span><span style=display:flex><span><span style=color:#e6db74> &#34;</span>ruleParameters<span style=color:#e6db74>&#34;: &#34;</span><span style=color:#f92672>{</span><span style=color:#e6db74>&#34;Key&#34;</span>:<span style=color:#e6db74>&#34;Value&#34;</span><span style=color:#f92672>}</span><span style=color:#e6db74>&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74> &#34;</span>resultToken<span style=color:#e6db74>&#34;: &#34;</span>ResultToken<span style=color:#e6db74>&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74> &#34;</span>eventLeftScope<span style=color:#e6db74>&#34;: false,
</span></span></span><span style=display:flex><span><span style=color:#e6db74> &#34;</span>executionRoleArn<span style=color:#e6db74>&#34;: &#34;</span>arn:aws:iam::123456789012:role/config-role<span style=color:#e6db74>&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74> &#34;</span>configRuleArn<span style=color:#e6db74>&#34;: &#34;</span>arn:aws:config:us-east-1:123456789012:config-rule/config-rule<span style=color:#e6db74>&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74> &#34;</span>configRuleName<span style=color:#e6db74>&#34;: &#34;</span>change-triggered-config-rule<span style=color:#e6db74>&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74> &#34;</span>configRuleId<span style=color:#e6db74>&#34;: &#34;</span>config-rule<span style=color:#e6db74>&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74> &#34;</span>accountId<span style=color:#e6db74>&#34;: &#34;</span>123456789012<span style=color:#e6db74>&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74> &#34;</span>version<span style=color:#e6db74>&#34;: &#34;</span>1.0<span style=color:#e6db74>&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}</span></span></span></code></pre></div><br>
When it comes to periodic trigger the event pattern that is published is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;invokingEvent&#34;</span>: <span style=color:#e6db74>&#34;{&#34;</span>awsAccountId<span style=color:#e6db74>&#34;:&#34;</span>123456789012<span style=color:#e6db74>&#34;,&#34;</span>notificationCreationTime<span style=color:#e6db74>&#34;:&#34;</span>2016-07-13T21:50:00.373Z<span style=color:#e6db74>&#34;,&#34;</span>messageType<span style=color:#e6db74>&#34;:&#34;</span>ScheduledNotification<span style=color:#e6db74>&#34;,&#34;</span>recordVersion<span style=color:#e6db74>&#34;:&#34;</span>1.0<span style=color:#e6db74>&#34;}&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;ruleParameters&#34;</span>: <span style=color:#e6db74>&#34;{&#34;</span>Key<span style=color:#e6db74>&#34;:&#34;</span>Value<span style=color:#e6db74>&#34;}&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;resultToken&#34;</span>: <span style=color:#e6db74>&#34;ResultToken&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;eventLeftScope&#34;</span>: false,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;executionRoleArn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:iam::123456789012:role/config-role&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;configRuleArn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:config:us-east-1:123456789012:config-rule/config-rule&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;configRuleName&#34;</span>: <span style=color:#e6db74>&#34;periodic-config-rule&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;configRuleId&#34;</span>: <span style=color:#e6db74>&#34;config-rule&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;accountId&#34;</span>: <span style=color:#e6db74>&#34;123456789012&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;version&#34;</span>: <span style=color:#e6db74>&#34;1.0&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span></span></span></code></pre></div><p>If you take a close look at the <code>invokingEvent</code> in the JSON object for both the event patterns you will see that the event pattern for the configuration change has the attribute <code>configurationItem</code> but in the event pattern for the periodic trigger the attribute <code>configurationItem</code> does not exist.</p><p>The attribute <code>configurationItem</code> mainly contains details of a particular resource it’s monitoring in our case an EC2 instance, referring back to the event pattern for a configuration change you can see details such as instance id, relationship of the instance to EIPs, tags attached to the instance but the <code>invokingEvent</code> in the event pattern for the periodic trigger does not have any of these values and it only has accountId, messageType which are of no use to us. <a href=https://docs.aws.amazon.com/config/latest/developerguide/evaluate-config_develop-rules_example-events.html>For more details on rest of the attributes in the Event Pattern.</a></p><p>So when it comes to using configuration change most of the work is cut out for us as config sends data about the resource we are monitoring from which we can parse the data and determine whether the rule is compliant or non compliant, if we were to use the periodic trigger we would have to make a API call to the AWS service we are checking the compliance for and send the evaluated data back to config.</p><p>The <em>main drawback</em> of using a periodic trigger is that if and when there is a change in a particular resource, config will not get triggered immediately and we wouldn’t know if there was a violation happening but we would know about it based on the frequency at which the evaluations happen which can be 1 hour, 6 hour or even the next day which is not feasible.</p><p>When it comes to configurational changes the evaluations are immediate, for example, if a user attaches a EIP to a instance making it a public instance which is meant to be private then config triggers the rule and the instance is shown as non compliant due to the violation.</p><p>Before you create a rule you can get the configuration history of a resource by using the CLI command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws configservice get-resource-config-history --resource-type AWS::EC2::Instance --resource-id i-00000 --region us-east-1</span></span></code></pre></div><p>With the generated configuration details you can develop your code locally.</p><p>Let’s take a look at a custom rule which checks if the instance is publicly accessible or not and treat a publicly accessible instance as non compliant and the trigger type of this rule is configuration changes.</p><ul>
<li>lambda_handler:</li></ul><script type=application/javascript src=https://gist.github.com/jsanant/4b93e31b225bca2c8d7fb3284e1a8ff2.js></script>
<ul>
<li>
<p>In Line 5: We are parsing out the invokingEvent to get the configurationItem.</p></li><li>
<p>In Line 12: Here we are checking if the resource (instance) is deleted or not, this is an important check because if the resource is deleted we wouldn’t want stale data showing up on the config dashboard so we perform this check before we compute the evaluation.</p></li><li>
<p>evaluate_compliance:</p></li></ul><script type=application/javascript src=https://gist.github.com/jsanant/701c72c86684c06efd710e391cb869ee.js></script>
<ul>
<li>In Line 13: We are checking if the instance is publicly accessible or not.</li></ul><p>After computation it returns the <code>compliance_type</code> and <code>annotation</code> to the <code>put_evaluations()</code> request.</p><p>As you can see from the two snippets above we didn’t use any <a href=#word-to-the-wise>boto3</a> calls (Other than the <code>put_evaluations()</code> call to config) to the EC2 service to get details of the instance, all the data about the instance was published to lambda by config when we chose the trigger type as configuration changes.</p><p>As a exercise go ahead and create a custom rule and choose the trigger type as periodic trigger and see how different it is from configuration changes.</p><hr>
<h3 id=word-to-the-wise>Word to the wise:<a hidden class=anchor aria-hidden=true href=#word-to-the-wise>#</a></h3><ul>
<li>
<p>There are some resource specific attributes that are not monitored by Config <a href=https://docs.aws.amazon.com/config/latest/developerguide/resource-config-reference.html>More details here</a>. If you have a custom rule that checks if the bucket is encrypted or not you will have to use boto3 calls to fetch the details about the bucket since the AWS S3 bucket encryption is not monitored by config.</p></li><li>
<p>When you are logged into the AWS Config console and you want to evaluate a rule you would essentially click on Re-Evaluate, the most important thing note here is that it causes a configuration change to occur.</p></li><li>
<p><a href=https://github.com/awslabs/aws-config-rules>AWS Community repo for Custom Config Rules.</a></p></li></ul><hr>
<h3 id=since-you-stayed-till-the-end-you-get-bonus-content>Since you stayed till the end you get bonus content!<a hidden class=anchor aria-hidden=true href=#since-you-stayed-till-the-end-you-get-bonus-content>#</a></h3><p><img loading=lazy src=/money.gif#center alt=money>
</p><p><a href=https://aws.amazon.com/config/pricing/>AWS Config is a costly service.</a></p><h4 id=alternatives-to-aws-config>Alternatives to AWS Config:<a hidden class=anchor aria-hidden=true href=#alternatives-to-aws-config>#</a></h4><ul>
<li><a href=https://github.com/cloud-custodian/cloud-custodian>Cloud Custodian</a>: It’s a open source tool by Capital One.</li><li><a href=https://github.com/Netflix/SimianArmy/wiki/Janitor-Home>Janitor Monkey</a>: A open source tool created by Netflix but it is very restrictive to the Netflix environment.</li><li><a href=https://github.com/Netflix/security_monkey>Security Monkey</a>: Another open source tool by Netflix for monitoring your environment.</li></ul><hr>
<p>I hope this article helped you understand how to create custom Config rules and how the different trigger types work.</p><p>Thank you for reading! Hope you enjoyed it. Appreciate your feedback.</p></div><footer class=post-footer>
<ul class=post-tags>
<li><a href=https://srinivasanant.com/tags/aws/>AWS</a></li><li><a href=https://srinivasanant.com/tags/aws-config/>AWS Config</a></li></ul></footer></article></main><footer class=footer>
<span>&copy; 2022 <a href=https://srinivasanant.com>Srinivas Anant</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script>
</body></html>